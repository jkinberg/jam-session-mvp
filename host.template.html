<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jam Session - Host</title>

    <!-- Primary Meta Tags -->
    <meta name="title" content="Jam Session - Multiplayer Music Party Game">
    <meta name="description" content="Turn your phones into instruments! Play drums, bass, and chords together in this free multiplayer music jam session. Perfect for parties.">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://jam-mvp-xi.vercel.app/">
    <meta property="og:title" content="Jam Session - Multiplayer Music Party Game">
    <meta property="og:description" content="Turn your phones into instruments! Play drums, bass, and chords together in this free multiplayer music jam session. Perfect for parties.">
    <!-- TODO: Add og:image once social-share.png is created -->
    <!-- <meta property="og:image" content="https://jam-mvp-xi.vercel.app/social-share.png"> -->

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://jam-mvp-xi.vercel.app/">
    <meta property="twitter:title" content="Jam Session - Multiplayer Music Party Game">
    <meta property="twitter:description" content="Turn your phones into instruments! Play drums, bass, and chords together in this free multiplayer music jam session. Perfect for parties.">
    <!-- TODO: Add twitter:image once social-share.png is created -->
    <!-- <meta property="twitter:image" content="https://jam-mvp-xi.vercel.app/social-share.png"> -->

    <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #1a1a2e 100%);
            color: white;
            min-height: 100vh;
            overflow: hidden;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
        }
        
        .room-code {
            background: rgba(255,255,255,0.1);
            padding: 10px 24px;
            border-radius: 50px;
            font-size: 18px;
        }
        
        .room-code span {
            font-weight: bold;
            color: #00d4ff;
            font-family: monospace;
            font-size: 24px;
            letter-spacing: 4px;
        }
        
        .timer {
            background: rgba(255,255,255,0.1);
            padding: 10px 24px;
            border-radius: 50px;
            font-size: 32px;
            font-family: monospace;
            font-weight: bold;
        }
        
        .timer.warning {
            color: #ff6b6b;
            animation: pulse 1s infinite;
        }

        .end-session-btn {
            background: rgba(239, 68, 68, 0.2);
            border: 2px solid rgba(239, 68, 68, 0.5);
            color: #ff6b6b;
            padding: 8px 20px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .end-session-btn:hover {
            background: rgba(239, 68, 68, 0.3);
            border-color: #ff6b6b;
        }

        .end-session-btn.hidden {
            display: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Beat indicator */
        .beat-section {
            text-align: center;
            padding: 15px 0;
        }
        
        .beat-indicator {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .beat-dot {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            transition: all 0.1s ease;
        }
        
        .beat-dot.active {
            background: #00d4ff;
            box-shadow: 0 0 30px #00d4ff;
            transform: scale(1.3);
        }
        
        .bpm {
            color: rgba(255,255,255,0.5);
            font-size: 14px;
        }
        
        /* Visualizer */
        .visualizer {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .pulse-ring {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.2);
            position: absolute;
            transition: all 0.1s ease;
        }

        .pulse-ring.active {
            transform: scale(1.5);
            opacity: 0;
        }

        .center-circle {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            box-shadow: 0 0 40px rgba(102, 126, 234, 0.5);
            transition: all 0.1s ease;
        }
        
        .center-circle.pulse {
            transform: scale(1.1);
            box-shadow: 0 0 100px rgba(102, 126, 234, 0.8);
        }
        
        /* Activity indicators */
        .activity-flash {
            position: absolute;
            width: 200px;
            height: 200px;
            border-radius: 50%;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.1s;
        }
        
        .activity-flash.drums {
            background: radial-gradient(circle, rgba(239,68,68,0.4) 0%, transparent 70%);
        }
        
        .activity-flash.bass {
            background: radial-gradient(circle, rgba(168,85,247,0.4) 0%, transparent 70%);
        }
        
        .activity-flash.chords {
            background: radial-gradient(circle, rgba(236,72,153,0.4) 0%, transparent 70%);
        }
        
        .activity-flash.active {
            opacity: 1;
        }
        
        /* Instruments panel */
        .instruments {
            display: flex;
            justify-content: center;
            gap: 15px;
            padding: 15px 0;
        }

        .instrument-card {
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 12px 20px;
            text-align: center;
            min-width: 140px;
            transition: all 0.3s ease;
        }
        
        .instrument-card.connected {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }
        
        .instrument-card .emoji {
            font-size: 28px;
            margin-bottom: 6px;
        }

        .instrument-card .name {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .instrument-card .status {
            font-size: 12px;
            color: rgba(255,255,255,0.5);
        }
        
        .instrument-card.connected .status {
            color: #10b981;
        }
        
        .instrument-card .activity-bar {
            display: flex;
            justify-content: center;
            gap: 2px;
            margin-top: 6px;
            height: 15px;
        }
        
        .instrument-card .activity-bar .bar {
            width: 4px;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
            transition: height 0.1s;
        }
        
        .instrument-card.connected .activity-bar .bar {
            background: #10b981;
        }
        
        /* Join URLs */
        .join-section {
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            padding: 10px;
            margin-top: auto;
        }

        .join-section h3 {
            margin-bottom: 8px;
            color: rgba(255,255,255,0.7);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .join-urls {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .join-url {
            flex: 1;
            min-width: 140px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .join-url .label {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-bottom: 6px;
            font-weight: bold;
            font-size: 12px;
        }

        .join-url .qr-code {
            background: white;
            padding: 6px;
            border-radius: 6px;
            margin-bottom: 6px;
        }

        .join-url .qr-code img {
            display: block;
            width: 80px;
            height: 80px;
        }

        .ip-config {
            background: rgba(255,165,0,0.1);
            border: 1px solid rgba(255,165,0,0.3);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 12px;
        }

        .ip-config input {
            flex: 1;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-family: monospace;
        }

        .ip-config button {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: bold;
        }

        .ip-config button:hover {
            background: rgba(255,255,255,0.3);
        }

        .join-url .url {
            font-family: monospace;
            font-size: 8px;
            color: #00d4ff;
            word-break: break-all;
            opacity: 0.6;
            line-height: 1.2;
        }
        
        /* Start overlay */
        .start-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        
        .start-overlay.hidden {
            display: none;
        }
        
        .start-overlay h1 {
            font-size: 48px;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #00d4ff, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .start-overlay p {
            color: rgba(255,255,255,0.6);
            margin-bottom: 40px;
        }
        
        .start-btn {
            background: linear-gradient(135deg, #00d4ff, #764ba2);
            border: none;
            color: white;
            padding: 20px 60px;
            font-size: 24px;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .start-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 40px rgba(0, 212, 255, 0.4);
        }
        
        /* Session end overlay */
        .end-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        
        .end-overlay.hidden {
            display: none;
        }
        
        .end-overlay h1 {
            font-size: 48px;
            margin-bottom: 30px;
        }
        
        .end-overlay .stats {
            display: flex;
            gap: 40px;
            margin-bottom: 40px;
        }
        
        .end-overlay .stat {
            text-align: center;
        }
        
        .end-overlay .stat .value {
            font-size: 48px;
            font-weight: bold;
            color: #00d4ff;
        }
        
        .end-overlay .stat .label {
            color: rgba(255,255,255,0.6);
        }
        
        .end-overlay .buttons {
            display: flex;
            gap: 20px;
        }
        
        .end-overlay button {
            padding: 15px 40px;
            font-size: 18px;
            border-radius: 50px;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }
        
        .end-overlay .play-again {
            background: linear-gradient(135deg, #00d4ff, #764ba2);
            color: white;
        }
        
        .end-overlay .new-room {
            background: rgba(255,255,255,0.1);
            color: white;
        }
    </style>
</head>
<body>
    <!-- Start overlay -->
    <div class="start-overlay" id="startOverlay">
        <h1>üéµ JAM SESSION</h1>
        <p>Multiplayer music experience</p>
        <button class="start-btn" id="startBtn">START HOST</button>
    </div>
    
    <!-- End overlay -->
    <div class="end-overlay hidden" id="endOverlay">
        <h1>üéâ Session Complete!</h1>
        <div class="stats">
            <div class="stat">
                <div class="value" id="statNotes">0</div>
                <div class="label">Notes Played</div>
            </div>
            <div class="stat">
                <div class="value" id="statPlayers">0</div>
                <div class="label">Players</div>
            </div>
        </div>

        <!-- Survey Section with QR Code -->
        <div style="background: rgba(255,255,255,0.1); border-radius: 12px; padding: 16px; margin: 20px 0;">
            <div style="color: #00d4ff; font-weight: bold; font-size: 16px; margin-bottom: 10px;">
                üìã Help us improve!
            </div>
            <div style="color: rgba(255,255,255,0.8); font-size: 13px; margin-bottom: 12px;">
                Scan QR code or click link to share feedback (takes 3 min)
            </div>
            <div style="display: flex; align-items: center; justify-content: center; gap: 20px;">
                <div style="background: white; padding: 8px; border-radius: 8px;">
                    <img id="surveyQR" style="width: 100px; height: 100px;" alt="Survey QR Code">
                </div>
                <a href="https://forms.gle/3KSkcUiae2DvfePr9" target="_blank" style="
                    display: inline-block;
                    background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
                    color: white;
                    padding: 12px 20px;
                    border-radius: 8px;
                    text-decoration: none;
                    font-weight: bold;
                    font-size: 14px;
                    transition: transform 0.2s;
                " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                    üìù Take Survey
                </a>
            </div>
        </div>

        <div class="buttons">
            <button class="play-again" id="playAgainBtn">Play Again</button>
            <button class="new-room" id="newRoomBtn">New Room</button>
        </div>
    </div>
    
    <!-- Main content -->
    <div class="container">
        <div class="header">
            <div class="room-code">
                Room: <span id="roomCode">----</span>
            </div>
            <div style="display: flex; align-items: center; gap: 12px;">
                <div class="timer" id="timer">3:00</div>
                <button class="end-session-btn hidden" id="endSessionBtn">End Session</button>
            </div>
        </div>
        
        <div class="beat-section">
            <div class="beat-indicator">
                <div class="beat-dot" data-beat="0"></div>
                <div class="beat-dot" data-beat="1"></div>
                <div class="beat-dot" data-beat="2"></div>
                <div class="beat-dot" data-beat="3"></div>
            </div>
            <div class="bpm">120 BPM</div>
        </div>
        
        <div class="visualizer">
            <div class="activity-flash drums"></div>
            <div class="activity-flash bass"></div>
            <div class="activity-flash chords"></div>
            <div class="pulse-ring"></div>
            <div class="center-circle">üéµ</div>
        </div>
        
        <div class="instruments">
            <div class="instrument-card" id="card-drums">
                <div class="emoji">ü•Å</div>
                <div class="name">Drums</div>
                <div class="status">Waiting...</div>
                <div class="activity-bar">
                    <div class="bar"></div>
                    <div class="bar"></div>
                    <div class="bar"></div>
                    <div class="bar"></div>
                    <div class="bar"></div>
                </div>
            </div>
            <div class="instrument-card" id="card-bass">
                <div class="emoji">üé∏</div>
                <div class="name">Bass</div>
                <div class="status">Waiting...</div>
                <div class="activity-bar">
                    <div class="bar"></div>
                    <div class="bar"></div>
                    <div class="bar"></div>
                    <div class="bar"></div>
                    <div class="bar"></div>
                </div>
            </div>
            <div class="instrument-card" id="card-chords">
                <div class="emoji">üéπ</div>
                <div class="name">Chords</div>
                <div class="status">Waiting...</div>
                <div class="activity-bar">
                    <div class="bar"></div>
                    <div class="bar"></div>
                    <div class="bar"></div>
                    <div class="bar"></div>
                    <div class="bar"></div>
                </div>
            </div>
        </div>
        
        <div class="join-section">
            <h3>üì± Join on your phone</h3>
            <div class="ip-config" id="ipConfig" style="display: none;">
                <span>‚ö†Ô∏è Using localhost - Enter your IP:</span>
                <input type="text" id="hostIpInput" placeholder="e.g. 192.168.1.100">
                <button id="updateIpBtn">Update</button>
            </div>
            <div class="join-urls" id="joinUrls">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        
        // IMPORTANT: Replace with your Ably API key
        // Get a free key at: https://ably.com/sign-up
        const ABLY_API_KEY = '__ABLY_API_KEY__';
        
        const SESSION_DURATION = 180; // 3 minutes in seconds
        const BPM = 120;
        const QUANTIZE_SUBDIVISION = '8n'; // Quantize to 8th notes (more immediate feel)
        
        // ============================================
        // STATE
        // ============================================
        
        let roomCode = '';
        let channel = null;
        let isPlaying = false;
        let timeRemaining = SESSION_DURATION;
        let timerInterval = null;
        let currentBeat = 0;
        let totalNotes = 0;
        let customHost = ''; // For overriding localhost with actual IP
        let beatEventId = null; // Store the scheduled beat callback ID
        
        const players = {
            drums: { connected: false, name: null },
            bass: { connected: false, name: null },
            chords: { connected: false, name: null }
        };
        
        // ============================================
        // AUDIO SETUP (Tone.js)
        // ============================================
        
        // Drum samples using built-in synths (no external files needed)
        // With stereo panning for better spatial mix
        const drumSynths = {
            kick: new Tone.MembraneSynth({
                pitchDecay: 0.05,
                octaves: 6,
                oscillator: { type: 'sine' },
                envelope: { attack: 0.001, decay: 0.4, sustain: 0.01, release: 1.4 }
            }).chain(
                new Tone.Panner(0).toDestination() // Center (kick is foundation)
            ),

            snare: new Tone.NoiseSynth({
                noise: { type: 'white' },
                envelope: { attack: 0.001, decay: 0.2, sustain: 0, release: 0.2 }
            }).chain(
                new Tone.Panner(-0.2).toDestination() // Slight left
            ),

            hat: new Tone.MetalSynth({
                frequency: 400,
                envelope: { attack: 0.001, decay: 0.1, release: 0.1 },
                harmonicity: 5.1,
                modulationIndex: 32,
                resonance: 4000,
                octaves: 1.5
            }).chain(
                new Tone.Panner(0.4).toDestination() // Right
            ),

            clap: new Tone.NoiseSynth({
                noise: { type: 'pink' },
                envelope: { attack: 0.005, decay: 0.1, sustain: 0, release: 0.1 }
            }).chain(
                new Tone.Panner(-0.3).toDestination() // Left
            )
        };

        // Bass synth (centered, foundation)
        const bassSynth = new Tone.MonoSynth({
            oscillator: { type: 'sawtooth' },
            filter: { Q: 2, type: 'lowpass', rolloff: -24 },
            envelope: { attack: 0.01, decay: 0.3, sustain: 0.4, release: 0.8 },
            filterEnvelope: { attack: 0.01, decay: 0.2, sustain: 0.5, release: 0.8, baseFrequency: 100, octaves: 2.5 }
        }).toDestination();

        // Chord synth (polyphonic, slightly spread)
        const chordSynth = new Tone.PolySynth(Tone.Synth, {
            oscillator: { type: 'triangle' },
            envelope: { attack: 0.02, decay: 0.3, sustain: 0.4, release: 1 }
        }).chain(
            new Tone.Panner(0.1).toDestination() // Slight right to avoid bass clash
        );

        // Rebalanced volumes for better mix
        // Kick and bass are foundation, everything else supports
        drumSynths.kick.volume.value = -3;   // Louder - foundation
        drumSynths.snare.volume.value = -8;  // Medium - backbeat
        drumSynths.hat.volume.value = -14;   // Quieter - texture
        drumSynths.clap.volume.value = -10;  // Medium-quiet - accent
        bassSynth.volume.value = -6;         // Loud - groove foundation
        chordSynth.volume.value = -12;       // Quieter - harmony support
        
        // Chord definitions (in C major/A minor scale)
        // Raised one octave to avoid clashing with bass frequencies
        const chordNotes = {
            'Am': ['A3', 'C4', 'E4'],
            'F': ['F3', 'A3', 'C4'],
            'C': ['C3', 'E3', 'G3'],
            'G': ['G3', 'B3', 'D4'],
            'Em': ['E3', 'G3', 'B3'],
            'Dm': ['D3', 'F3', 'A3']
        };
        
        // Bass notes (C minor pentatonic for "no wrong notes")
        const bassNotes = {
            'C': 'C2',
            'D': 'D2',
            'E': 'Eb2', // Flat for minor feel
            'F': 'F2',
            'G': 'G2',
            'A': 'Ab2', // Flat for minor feel
            'B': 'Bb2'  // Flat for minor feel
        };
        
        // ============================================
        // PLAY SOUNDS (with quantization)
        // ============================================
        
        function playDrum(note, velocity = 0.7) {
            const time = Tone.Transport.nextSubdivision(QUANTIZE_SUBDIVISION);

            switch(note) {
                case 'kick':
                    drumSynths.kick.triggerAttackRelease('C1', '8n', time, velocity);
                    break;
                case 'snare':
                    drumSynths.snare.triggerAttackRelease('8n', time, velocity);
                    break;
                case 'hat':
                    drumSynths.hat.triggerAttackRelease('C6', '32n', time, velocity * 0.8);
                    break;
                case 'clap':
                    drumSynths.clap.triggerAttackRelease('16n', time, velocity);
                    break;
            }

            showActivity('drums');
            totalNotes++;
        }
        
        function playBass(note, action = 'on') {
            const actualNote = bassNotes[note] || 'C2';

            if (action === 'on') {
                // Start sustaining the note (immediate, no quantization)
                bassSynth.triggerAttack(actualNote);
                showActivity('bass');
                totalNotes++;
            } else if (action === 'off') {
                // Release the note (immediate, no quantization)
                bassSynth.triggerRelease();
            }
        }
        
        function playChord(chord, action = 'on') {
            const notes = chordNotes[chord] || chordNotes['Am'];

            if (action === 'on') {
                // Start sustaining the chord (immediate, no quantization)
                chordSynth.triggerAttack(notes);
                showActivity('chords');
                totalNotes++;
            } else if (action === 'off') {
                // Release the specific chord notes (immediate, no quantization)
                chordSynth.triggerRelease(notes);
            }
        }
        
        // ============================================
        // VISUAL FEEDBACK
        // ============================================
        
        function showActivity(instrument) {
            // Flash the center circle
            const center = document.querySelector('.center-circle');
            center.classList.add('pulse');
            setTimeout(() => center.classList.remove('pulse'), 100);
            
            // Flash the activity overlay
            const flash = document.querySelector(`.activity-flash.${instrument}`);
            flash.classList.add('active');
            setTimeout(() => flash.classList.remove('active'), 150);
            
            // Animate the instrument card activity bars
            const card = document.getElementById(`card-${instrument}`);
            const bars = card.querySelectorAll('.activity-bar .bar');
            bars.forEach(bar => {
                bar.style.height = `${5 + Math.random() * 15}px`;
            });
            setTimeout(() => {
                bars.forEach(bar => {
                    bar.style.height = '5px';
                });
            }, 200);
        }
        
        function updateBeatIndicator(beat) {
            const dots = document.querySelectorAll('.beat-dot');
            dots.forEach((dot, i) => {
                dot.classList.toggle('active', i === beat);
            });
            
            // Pulse ring on beat 1
            if (beat === 0) {
                const ring = document.querySelector('.pulse-ring');
                ring.classList.add('active');
                setTimeout(() => ring.classList.remove('active'), 300);
            }
        }
        
        // ============================================
        // TIMER
        // ============================================
        
        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            const display = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            const timerEl = document.getElementById('timer');
            timerEl.textContent = display;
            
            if (timeRemaining <= 30) {
                timerEl.classList.add('warning');
            }
        }
        
        function startTimer() {
            timerInterval = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                // Broadcast time to players
                if (channel) {
                    channel.publish('session', { 
                        type: 'session', 
                        status: 'playing', 
                        timeRemaining 
                    });
                }
                
                if (timeRemaining <= 0) {
                    endSession();
                }
            }, 1000);
        }
        
        function endSession() {
            isPlaying = false;
            clearInterval(timerInterval);
            Tone.Transport.stop();

            // Clear the beat callback
            if (beatEventId !== null) {
                Tone.Transport.clear(beatEventId);
                beatEventId = null;
            }

            // Release all sustained notes (bass and chords)
            // This prevents notes from continuing to play after session ends
            bassSynth.triggerRelease();
            chordSynth.releaseAll();

            // Hide end session button
            document.getElementById('endSessionBtn').classList.add('hidden');

            // Show end screen
            document.getElementById('statNotes').textContent = totalNotes;
            document.getElementById('statPlayers').textContent =
                Object.values(players).filter(p => p.connected).length;
            document.getElementById('endOverlay').classList.remove('hidden');

            // Generate survey QR code
            const surveyQR = document.getElementById('surveyQR');
            surveyQR.src = 'https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=' +
                          encodeURIComponent('https://forms.gle/3KSkcUiae2DvfePr9');

            // Notify players
            if (channel) {
                channel.publish('session', { type: 'session', status: 'ended' });
            }
        }
        
        // ============================================
        // ROOM & CONNECTION SETUP
        // ============================================
        
        function generateRoomCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 4; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }
        
        function updateJoinUrls() {
            // Determine the base URL to use
            let origin = customHost || window.location.origin;

            // Handle both /host.html and / (index.html) paths
            let pathname = window.location.pathname;
            if (pathname.includes('host.html')) {
                pathname = pathname.replace('host.html', 'play.html');
            } else if (pathname === '/' || pathname.includes('index.html')) {
                pathname = '/play.html';
            }
            const baseUrl = origin + pathname;
            const container = document.getElementById('joinUrls');

            // Show IP config warning if using localhost
            const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            const ipConfig = document.getElementById('ipConfig');
            if (isLocalhost && !customHost) {
                ipConfig.style.display = 'flex';
            } else {
                ipConfig.style.display = 'none';
            }

            const instruments = [
                { id: 'drums', emoji: 'ü•Å', name: 'Drums' },
                { id: 'bass', emoji: 'üé∏', name: 'Bass' },
                { id: 'chords', emoji: 'üéπ', name: 'Chords' }
            ];

            container.innerHTML = instruments.map(inst => {
                const url = `${baseUrl}?room=${roomCode}&instrument=${inst.id}`;
                const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=80x80&data=${encodeURIComponent(url)}`;

                return `
                    <div class="join-url">
                        <div class="label">${inst.emoji} ${inst.name}</div>
                        <div class="qr-code">
                            <img src="${qrCodeUrl}" alt="QR code for ${inst.name}" />
                        </div>
                        <div class="url">${url}</div>
                    </div>
                `;
            }).join('');
        }
        
        function updatePlayerStatus(instrument, connected, name = null) {
            players[instrument] = { connected, name };
            
            const card = document.getElementById(`card-${instrument}`);
            const status = card.querySelector('.status');
            
            if (connected) {
                card.classList.add('connected');
                status.textContent = name || 'Connected';
            } else {
                card.classList.remove('connected');
                status.textContent = 'Waiting...';
            }
        }
        
        async function setupAbly() {
            if (ABLY_API_KEY === 'YOUR_ABLY_API_KEY_HERE') {
                alert('Please add your Ably API key in host.html!\n\nGet a free key at: https://ably.com/sign-up');
                return false;
            }
            
            const ably = new Ably.Realtime(ABLY_API_KEY);
            channel = ably.channels.get(`jam-${roomCode}`);
            
            // Listen for player messages
            channel.subscribe('player', (message) => {
                const data = message.data;
                
                switch(data.type) {
                    case 'join':
                        updatePlayerStatus(data.instrument, true, data.name);
                        break;
                    case 'leave':
                        updatePlayerStatus(data.instrument, false);
                        break;
                    case 'drums':
                        if (isPlaying) playDrum(data.note, data.velocity);
                        break;
                    case 'bass':
                        if (isPlaying) playBass(data.note, data.action);
                        break;
                    case 'chords':
                        if (isPlaying) playChord(data.chord, data.action);
                        break;
                }
            });
            
            return true;
        }
        
        // ============================================
        // START SESSION
        // ============================================
        
        async function startSession() {
            // Initialize audio
            await Tone.start();

            // Release any sustained notes from previous session
            bassSynth.triggerRelease();
            chordSynth.releaseAll();

            // Set up transport
            Tone.Transport.bpm.value = BPM;

            // Clear any existing beat callback
            if (beatEventId !== null) {
                Tone.Transport.clear(beatEventId);
            }

            // Reset beat counter
            currentBeat = 0;

            // Beat callback - fires on every quarter note
            beatEventId = Tone.Transport.scheduleRepeat((time) => {
                // Update UI on main thread with current beat
                Tone.Draw.schedule(() => {
                    updateBeatIndicator(currentBeat);
                }, time);

                // Broadcast beat to players
                if (channel) {
                    channel.publish('host', { type: 'beat', beat: currentBeat });
                }

                // Increment for next beat
                currentBeat = (currentBeat + 1) % 4;
            }, '4n');

            // Reset transport position to start fresh
            Tone.Transport.position = 0;

            // Start transport
            Tone.Transport.start();
            isPlaying = true;

            // Show end session button
            document.getElementById('endSessionBtn').classList.remove('hidden');

            // Start timer
            startTimer();
            
            // Notify players with sync data
            if (channel) {
                channel.publish('session', {
                    type: 'session',
                    status: 'playing',
                    timeRemaining,
                    startTime: Date.now(),  // For beat sync
                    bpm: BPM                // For beat calculation
                });
            }
        }
        
        // ============================================
        // INITIALIZATION
        // ============================================
        
        async function init() {
            // Generate room code
            roomCode = generateRoomCode();
            document.getElementById('roomCode').textContent = roomCode;
            updateJoinUrls();
            
            // Set up Ably
            const ablyReady = await setupAbly();
            if (!ablyReady) return;
            
            // Start button handler
            document.getElementById('startBtn').addEventListener('click', async () => {
                document.getElementById('startOverlay').classList.add('hidden');
                await startSession();
            });
            
            // Play again button
            document.getElementById('playAgainBtn').addEventListener('click', () => {
                document.getElementById('endOverlay').classList.add('hidden');
                timeRemaining = SESSION_DURATION;
                totalNotes = 0;
                document.getElementById('timer').classList.remove('warning');
                updateTimerDisplay();
                startSession();
            });
            
            // New room button
            document.getElementById('newRoomBtn').addEventListener('click', () => {
                window.location.reload();
            });

            // IP update button
            document.getElementById('updateIpBtn').addEventListener('click', () => {
                const ipInput = document.getElementById('hostIpInput').value.trim();
                if (ipInput) {
                    // Add http:// if not present, and include port
                    const port = window.location.port || '8000';
                    customHost = ipInput.startsWith('http') ? ipInput : `http://${ipInput}:${port}`;
                    updateJoinUrls();
                }
            });

            // Allow Enter key in IP input
            document.getElementById('hostIpInput').addEventListener('keyup', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('updateIpBtn').click();
                }
            });

            // End session button
            document.getElementById('endSessionBtn').addEventListener('click', () => {
                if (confirm('Are you sure you want to end the session early?')) {
                    endSession();
                }
            });
        }

        // Start when page loads
        init();
    </script>
</body>
</html>
